---
- name: Create ssh key
  import_playbook: playbooks/create-sshkey.yml
- name: Start docker
  import_playbook: playbooks/start-docker.yml
- name: Install RootAsRole
  hosts: docker
  connection: ssh
  become: false
  roles:
    - rootasrole
  vars:
    command: "installed"
    sr_password: "no"
  ignore_errors: true
- name: On Docker,
  hosts: docker
  gather_facts: false
  tasks:
    - name: Deploy RootAsRole roles
      ansible.builtin.import_tasks: tasks/deploy_roles.yml
- name: Install Apache2
  ansible.builtin.import_playbook: scenario_sr_paper.yml
- name: Test Apache2
  connection: local
  hosts: localhost
  become: false
  tasks:
    - name: Test Apache2
      ansible.builtin.uri:
        url: "http://{{ ansible_host }}/index.html"
        status_code: 200
  ignore_errors: true
- name: Destroy docker
  hosts: localhost
  connection: local
  become: true
  become_method: sudo
  tasks:
    - name: Stop docker
      ansible.builtin.shell: docker stop $(docker ps -a -q)
      when: "keep_docker != true"
    - name: Remove docker
      ansible.builtin.shell: docker rm $(docker ps -a -q)
      when: "keep_docker != true"